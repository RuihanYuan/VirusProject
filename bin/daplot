#! /usr/bin/env python
# daplot.py
# creates a combined depth and annotation plot from a depth file and a GFF file


from dna_features_viewer import GraphicFeature, GraphicRecord
import seaborn as sns
from matplotlib import pyplot as plt, lines
from BCBio import GFF
import argparse
import yaml


__version__ = "1.1.0"  # 2024/10/11 HB+1


def parse_depth(depth_input):
	print(f"Parsing depth file {depth_input}")
	depth = []
	references = set()
	with open(depth_input) as depth_object:
		for row in depth_object:
			genome_id, position, depth_count = row.split()
			references.add(genome_id)
			# If multiple genome IDs have been found, raise error
			if len(references) > 1:
				raise Exception('This script only handles one genome - contig.')
			position = int(position) - 1
			# Num of reads covers a specific position in the genome
			depth_count = int(depth_count)
			if position >= len(depth):
				depth.extend([0] * (position - len(depth) + 1))
			depth[position] = depth_count
	print(f"Parsed depth file {depth_input}")
	return depth


def plot_depth(ax, depth_input, is_normalize, depth_cut_off):
	data = parse_depth(depth_input)
	y_label = "Normalized Coverage" if is_normalize else "Coverage"
	data = [xx / max(data) for xx in data] if is_normalize else data
	sns.set_theme(color_codes=True)
	sns.lineplot(x=range(len(data)), y=data, ax=ax)
	ax.set(xlabel='Genome Position (bp)', ylabel=y_label)
	if not is_normalize:
		ax.add_line(lines.Line2D([0, len(data) + 1], [depth_cut_off], color="r"))


def load_color_settings(yml_file):
	with open(yml_file, 'r') as file:
		settings = yaml.safe_load(file)
	print(f"Color mappings loaded from {yml_file}")
	return settings['color_mapping'], settings['default_color']


def main():
	parser = argparse.ArgumentParser(description="Generate combined depth and annotation plots from a depth file and a GFF file.",
									 formatter_class=argparse.RawTextHelpFormatter)
	parser.add_argument("-id", "--input_depth",
						type=str,
						required=True,
						help='path to the input depth file')
	parser.add_argument("-ig", "--input_gff",
						type=str,
						required=True,
						help='path to the input GFF file')
	parser.add_argument("-o", "--output",
						type=str,
						required=True,
						help='path to save the output SVG file')
	parser.add_argument("-n", "--normalize",
						action="store_true",
						help=('normalize the depth values\n'
							  'default = False'))
	parser.add_argument("-c", "--cutoff",
						type=int,
						default=20,
						help=('depth cutoff value\n'
							  'default = 20'))
	parser.add_argument("-y", "--color_settings",
						type=str,
						help=('path to the color settings YAML file\n'
							  'defaults to program settings if left blank'))
	parser.add_argument("-v", "--version",
						action='version',
						version=f'%(prog)s {__version__}')

	args = parser.parse_args()

	color_mapping = {
		"P0 protein": "#da9100",
		"RNA-dependent RNA polymerase": "#009B77",
		"P1 protein": "#4D4DFF",
		"coat protein": "#E40046",
		"aphid transmission protein": "#FFE900",
		# Add more mappings as needed
	}

	default_color = "#D9D9D6"

	# Load color settings from the YAML file if provided
	if args.color_settings:
		color_mapping, default_color = load_color_settings(args.color_settings)

	fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(6, 3.5), sharex=True, gridspec_kw={"height_ratios": [3, 1]})

	graphic_features = []
	print(f"Parsing GFF file {args.input_gff}")
	# Parse the GFF3 file, create and add GraphicFeature objects to list
	with open(args.input_gff, "r") as gff_input:
		for gff_record in GFF.parse(gff_input):
			for feature in gff_record.features:
				if feature.type == "CDS":
					product = feature.qualifiers.get('product', [''])[0]
					color = color_mapping.get(product, default_color)
					graphic_feature = GraphicFeature(
						start  = int(feature.location.start),
						end    = int(feature.location.end),
						strand = feature.location.strand,
						color  = color,
						label  = product
					)
					graphic_features.append(graphic_feature)

			# Create a GraphicRecord with one GraphicFeature object
			graphic_record = GraphicRecord(sequence_length=len(gff_record), features=graphic_features)

			# Plot the graphic record on the first subplot
			graphic_record.plot(ax=ax1)
	print(f"Parsed GFF file {args.input_gff}")

	plot_depth(ax2, args.input_depth, is_normalize=args.normalize, depth_cut_off=args.cutoff)
	plt.tight_layout()
	print(f"Generating depth-annotation combined plot as {args.output}")
	fig.savefig(args.output, format='svg')

	print("----PLOT GENERATED----")


if __name__ == '__main__':
	main()
